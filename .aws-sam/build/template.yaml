AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'S3 file checker - tags small files, deletes large ones (>10 MB).

  '
Globals:
  Function:
    Runtime: python3.12
    Timeout: 30
    MemorySize: 128
Resources:
  UploadBucket:
    Type: AWS::S3::Bucket
    Properties:
      LifecycleConfiguration:
        Rules:
        - Id: DeleteAfter7Days
          Status: Enabled
          ExpirationInDays: 7
  FileCheckerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: FileCheckerFunction
      Handler: handler.lambda_handler
      Description: Tags small uploads; deletes uploads larger than 10 MB.
      Policies:
      - Statement:
        - Sid: AllowHeadAndTag
          Effect: Allow
          Action:
          - s3:GetObject
          - s3:GetObjectTagging
          - s3:PutObjectTagging
          Resource:
            Fn::Sub: arn:aws:s3:::${UploadBucket}/*
        - Sid: AllowDelete
          Effect: Allow
          Action:
          - s3:DeleteObject
          Resource:
            Fn::Sub: arn:aws:s3:::${UploadBucket}/*
      Events:
        S3Upload:
          Type: S3
          Properties:
            Bucket:
              Ref: UploadBucket
            Events: s3:ObjectCreated:*
    Metadata:
      SamResourceId: FileCheckerFunction
Outputs:
  BucketName:
    Description: Upload files to this bucket to trigger the function
    Value:
      Ref: UploadBucket
  FunctionName:
    Description: Lambda function name
    Value:
      Ref: FileCheckerFunction
